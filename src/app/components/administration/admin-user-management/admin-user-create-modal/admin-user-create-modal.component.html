<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 border-0 shadow-lg">

      <div class="modal-header border-bottom-0 pt-4 pb-2 px-4">
        <div>
          <h5 class="modal-title fw-bold fs-4 text-dark mb-1" id="createUserModalLabel">{{ isEditing ? 'Editar Usuario' : 'Nuevo Usuario' }}</h5>
          <p class="text-muted small mb-0">Complete las credenciales y asigne sus roles.</p>
        </div>
        <button type="button" class="btn-close mb-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body px-4 py-3">
        <form [formGroup]="createUserForm" (ngSubmit)="onSubmitCreate()" class="d-flex flex-column gap-3">

          <div>
            <div class="form-floating">
              <input type="text" class="form-control bg-light border-0 shadow-none" id="username" formControlName="username" placeholder="admin01"
                    [ngClass]="{'is-invalid': f['username'].invalid && (f['username'].dirty || f['username'].touched)}">
              <label for="username" class="text-muted fw-medium">Usuario</label>
            </div>
            @if (f['username'].hasError('required') && f['username'].touched) { <div class="text-danger mt-1 small">El usuario es obligatorio.</div> }
            @if (f['username'].hasError('minlength') && f['username'].touched) { <div class="text-danger mt-1 small">Mínimo 4 caracteres.</div> }
          </div>

          <div>
            <div class="form-floating">
              <input type="password" class="form-control bg-light border-0 shadow-none" id="password" formControlName="password" placeholder="123456"
                  [ngClass]="{'is-invalid': f['password'].invalid && (f['password'].dirty || f['password'].touched)}">
              <label for="password" class="text-muted fw-medium">Contraseña *</label>
            </div>
            @if (f['password'].invalid && f['password'].touched) {
                <div class="text-danger mt-1 small">La contraseña es obligatoria (mín. 6 caracteres).</div>
            }
          </div>

          <div class="mt-2">
            <label class="text-muted fw-medium small mb-2">Roles Asignados *</label>

            <div class="row g-2">
              @for (role of rolesList; track role.roleGId) {
                <div class="col-6">

                  <input type="checkbox" class="d-none" [id]="'role_' + role.roleGId"
                        (change)="onRoleToggle($event, role.roleGId)">

                  <label class="w-100 border rounded-3 p-3 transition-all"
                        style="cursor: pointer;"
                        [ngClass]="{
                          'border-success bg-success-subtle text-success': isRoleSelected(role.roleGId),
                          'border-light bg-light text-muted': !isRoleSelected(role.roleGId)
                        }"
                        [for]="'role_' + role.roleGId">
                    <div class="d-flex align-items-center gap-2">
                      <i class="bi fs-5" [ngClass]="isRoleSelected(role.roleGId) ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                      <span class="fw-medium small">{{ role.roleG }}</span>
                    </div>
                  </label>

                </div>
              }
            </div>

            @if (f['roleIds']?.invalid && f['roleIds']?.touched) {
              <div class="text-danger mt-2 small">Debe seleccionar al menos un rol para el usuario.</div>
            }
          </div>

        </form>
      </div>

      <div class="modal-footer border-top-0 px-4 pb-4 pt-1 justify-content-end gap-2">
        <button type="button" class="btn btn-light rounded-3 px-4 fw-medium text-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success rounded-3 px-4 fw-medium shadow-sm"
                [disabled]="createUserForm.invalid || isSubmitting" (click)="onSubmitCreate()">
          @if (isSubmitting) {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Creando...
          } @else {
            {{ isEditing ? 'Guardar Cambios' : 'Crear Usuario' }}
          }
        </button>
      </div>

    </div>
  </div>
</div>
