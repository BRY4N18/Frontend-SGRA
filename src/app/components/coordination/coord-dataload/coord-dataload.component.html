<div class="container-fluid p-0">
  <!-- Header Principal -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-dark mb-1">Carga de Información Base</h2>
      <p class="text-muted mb-0">Importa datos de estudiantes y docentes desde archivos Excel</p>
    </div>
  </div>

  <!-- Card de Carga Unificada -->
  <div class="card border-0 rounded-4 shadow-sm mb-4">
    <div class="card-header bg-white border-bottom-0 pt-4 pb-2 px-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h5 class="fw-bold text-dark d-flex align-items-center gap-2 mb-1">
          <i class="bi bi-cloud-arrow-up text-muted"></i> Subir Archivo
        </h5>
        <p class="text-muted small mb-0">Selecciona el tipo de datos y arrastra o selecciona tu archivo Excel.</p>
      </div>
      <div class="dropdown">
        <button class="btn btn-success dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i [class]="selectedOption.icon"></i>
          {{ selectedOption.label }}
        </button>

        <ul class="dropdown-menu shadow">
          <li *ngFor="let option of uploadOptions">
            <a class="dropdown-item d-flex align-items-center gap-2" href="javascript:void(0)" (click)="selectOption(option)">
              <i [class]="option.icon"></i>
              {{ option.label }}
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="card-body px-4 pb-4">
      <!-- Dropzone -->
      <div class="dropzone-container"
           [class.dragover]="isDragging"
           [class.has-file]="selectedFile"
           (click)="openFileSelect()"
           (drop)="onDrop($event)"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave()">

        <!-- Estado Vacío -->
        <div *ngIf="!selectedFile" class="dropzone-content text-center">
          <i class="bi bi-file-earmark-spreadsheet text-muted"></i>
          <p class="text-dark fw-semibold mb-1">Arrastra el archivo aquí</p>
          <p class="text-muted small mb-0">o <a href="javascript:void(0)" class="text-success fw-medium">haz clic para seleccionar</a></p>
          <small class="text-muted d-block mt-2">Formatos: .xls, .xlsx • Máx. 10 MB</small>
        </div>

        <!-- Estado con Archivo -->
        <div *ngIf="selectedFile" class="dropzone-content text-center" (click)="$event.stopPropagation()">
          <i class="bi bi-file-earmark-check text-success"></i>
          <p class="text-dark fw-semibold mb-1">{{ selectedFile.name }}</p>
          <small class="text-muted d-block mb-2">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</small>
          <button type="button" class="btn btn-sm btn-outline-danger rounded-pill px-3" (click)="clearFile($event); $event.stopPropagation()">
            <i class="bi bi-trash me-1"></i> Quitar
          </button>
        </div>
      </div>

      <!-- Botón de Subida -->
      <button class="btn btn-success w-100 mt-3" (click)="uploadData()" [disabled]="isLoading || !selectedFile">
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        <i *ngIf="!isLoading" class="bi bi-cloud-arrow-up me-2"></i>
        {{ isLoading ? 'Procesando...' : 'Subir datos' }}
      </button>
    </div>
  </div>

  <!-- Reporte de Carga -->
  <div class="card border-0 rounded-4 shadow-sm " *ngIf="uploadResults.length > 0">
    <div class="card-header bg-white border-bottom pt-4 pb-3 px-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h5 class="fw-bold text-dark d-flex align-items-center gap-2 mb-1">
            <i class="bi bi-clipboard-data text-muted"></i> Reporte de Carga
          </h5>
          <div class="d-flex gap-2 mt-2">
            <span class="badge bg-success-subtle text-success rounded-pill px-3">
              <i class="bi bi-check-circle me-1"></i>{{ successCount }} exitosos
            </span>
            <span class="badge bg-danger-subtle text-danger rounded-pill px-3">
              <i class="bi bi-exclamation-circle me-1"></i>{{ errorCount }} errores
            </span>
            <span class="badge bg-secondary-subtle text-secondary rounded-pill px-3">
              <i class="bi bi-list-ol me-1"></i>{{ uploadedItems }} filas
            </span>
          </div>
        </div>
        <button class="btn btn-outline-secondary rounded-pill px-4 fw-medium d-flex align-items-center gap-2">
          <i class="bi bi-download"></i> Exportar
        </button>
      </div>
    </div>

    <div class="card-body px-4 pb-4">
      <!-- Filtros -->
      <div class="d-flex gap-3 mb-4 align-items-center flex-wrap">
        <div class="input-group" style="max-width: 300px;">
          <input type="text"
                 class="form-control bg-light border-0 shadow-none"
                 placeholder="Buscar en resultados..."
                 [(ngModel)]="searchTerm"
                 (input)="filterResults()">
          <span class="input-group-text bg-light border-0 text-muted">
            <i class="bi bi-search"></i>
          </span>
        </div>

        <div class="btn-group" role="group">
          <button type="button"
                  class="btn btn-sm"
                  [class.btn-success]="currentFilterStatus === 'all'"
                  [class.btn-outline-secondary]="currentFilterStatus !== 'all'"
                  (click)="filterByStatus('all')">
            Todos
          </button>
          <button type="button"
                  class="btn btn-sm"
                  [class.btn-success]="currentFilterStatus === 'success'"
                  [class.btn-outline-secondary]="currentFilterStatus !== 'success'"
                  (click)="filterByStatus('success')">
            Exitosos
          </button>
          <button type="button"
                  class="btn btn-sm"
                  [class.btn-success]="currentFilterStatus === 'error'"
                  [class.btn-outline-secondary]="currentFilterStatus !== 'error'"
                  (click)="filterByStatus('error')">
            Errores
          </button>
        </div>
      </div>

      <!-- Tabla de Resultados -->
      <div *ngIf="paginatedResults.length > 0; else noResults" class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-transparent text-secondary small text-uppercase">
            <tr>
              <th scope="col" class="py-3 border-bottom border-2 text-center" style="width: 60px;">#</th>
              <th scope="col" class="py-3 border-bottom border-2" style="width: 120px;">Estado</th>
              <th scope="col" class="py-3 border-bottom border-2">Mensaje del Sistema</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of paginatedResults; let i = index">
              <td class="text-center text-muted fw-medium">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
              <td>
                <span *ngIf="result.status === 'success'"
                      class="badge bg-success-subtle text-success rounded-pill px-3">
                  <i class="bi bi-check-circle-fill me-1"></i>Éxito
                </span>
                <span *ngIf="result.status === 'error'"
                      class="badge bg-danger-subtle text-danger rounded-pill px-3">
                  <i class="bi bi-exclamation-circle-fill me-1"></i>Error
                </span>
              </td>
              <td class="text-dark">{{ result.message }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Sin Resultados -->
      <ng-template #noResults>
        <div class="text-center py-5">
          <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
          <p class="text-muted mt-3 mb-1">Sin resultados</p>
          <p class="text-muted small">No hay registros que coincidan con tu búsqueda.</p>
        </div>
      </ng-template>

      <!-- Paginación -->
      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top" *ngIf="uploadResults.length > pageSize">
        <small class="text-muted">
          Mostrando {{ (currentPage - 1) * pageSize + 1 }} a {{ Math.min(currentPage * pageSize, filteredResults.length) }} de {{ filteredResults.length }}
        </small>
        <nav aria-label="Paginación de resultados">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link rounded-start-pill" (click)="previousPage($event)" [disabled]="currentPage === 1">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>
            <li class="page-item disabled">
              <span class="page-link">{{ currentPage }} / {{ getTotalPages() }}</span>
            </li>
            <li class="page-item" [class.disabled]="!hasNextPage()">
              <button class="page-link rounded-end-pill" (click)="nextPage($event)" [disabled]="!hasNextPage()">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Hidden File Input -->
  <input type="file"
         #fileInput
         (change)="onFileSelected($event)"
         accept=".xlsx,.xls,.csv"
         style="display: none;">
</div>

<!-- MODAL DE ALERTA DE PRERREQUISITO -->
<div *ngIf="showPrerequisiteModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.15); position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1050; display: flex; align-items: center; justify-content: center;">
  <div class="modal-dialog modal-dialog-centered" style="margin: 0 auto;">
    <div class="modal-content border-2" style="border-color: #198754; background: #fff; min-width: 350px; max-width: 90vw;">
      <div class="modal-body text-center py-4">
        <div class="fw-bold text-success mb-2">
          <i class="bi bi-exclamation-circle me-2"></i> Atención
        </div>
        <div class="text-dark mb-3" style="font-size: 1.1rem;">{{ prerequisiteMessage }}</div>
        <button class="btn btn-success px-4 py-2 rounded-pill fw-bold" (click)="closePrerequisiteModal()">Aceptar</button>
      </div>
    </div>
  </div>
</div>
